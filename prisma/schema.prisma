// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Set DATABASE_URL in your .env file.
// Development example:  DATABASE_URL="postgresql://postgres:root@localhost:5432/ai_agent_db"
// Production example:   DATABASE_URL="postgresql://user:pass@host:5432/ai_agent_db?sslmode=require"
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  CANCELLED
  PENDING_MANUAL_REVIEW
  INVALID
}

enum CallStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  RETRY_SCHEDULED
  FAILED
}

model CustomerCall {
  id            String    @id @default(cuid())
  customerName  String
  phone         String
  // pending | calling | answered | failed | retrying
  status        String    @default("pending")
  retryCount    Int       @default(0)
  // nextRetryAt: when the cron should attempt the next retry
  nextRetryAt   DateTime?
  // vapiCallId / callSid: the call ID returned by Vapi (or Twilio)
  vapiCallId    String?
  // failureReason: last error message from Vapi / internal error
  failureReason String?
  lastCallAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ─── Order Confirmation Models ────────────────────────────────────────────────

model Order {
  id              String    @id @default(cuid())
  // Shopify order ID (numeric string) — unique per shop
  shopifyOrderId  String    @unique
  customerName    String
  // E.164 phone extracted from Shopify order
  phoneNumber     String
  storeName       String
  // Raw decimal string from Shopify, e.g. "599.00"
  totalPrice      String
  orderPlacedDate DateTime
  orderStatus     String      @default("PENDING")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  callLogs        CallLog[]
}

model CallLog {
  id            String    @id @default(cuid())
  orderId       String
  order         Order     @relation(fields: [orderId], references: [id])
  // The Vapi call ID — used to correlate webhook events
  vapiCallId    String?
  status        String    @default("QUEUED")
  // Number of retry attempts made by cron (not counting initial call)
  retryCount    Int       @default(0)
  nextRetryAt   DateTime?
  failureReason String?
  lastIntent    String?
  lockedAt      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([orderId])
  @@index([vapiCallId])
  @@index([status, nextRetryAt])
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}
